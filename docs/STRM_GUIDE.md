# STRM文件功能使用指南

## 什么是STRM文件？

STRM（Stream）文件是包含媒体文件路径或URL的纯文本文件，主要用于Kodi、Jellyfin、Emby等媒体中心软件。通过STRM文件，媒体中心可以播放实际的媒体文件，而无需移动或复制原始文件。

## 功能特点

- ✅ 支持绝对路径、相对路径、网络路径
- ✅ 支持单文件和多部分文件
- ✅ 支持多种内容格式（简单、详细、播放列表）
- ✅ 自动处理文件名清理和路径转换
- ✅ 跨平台兼容（Windows、Linux、macOS）
- ✅ 文件验证和错误处理

## 配置选项

### 基础配置

```yaml
strm:
  enable: true                          # 启用STRM文件生成
  path_type: "absolute"                 # 路径类型
  content_mode: "simple"                # 内容模式
  multipart_mode: "separate"            # 分片模式
```

### 路径类型 (path_type)

1. **absolute** - 绝对路径
   ```
   /home/user/movies/SSIS-001.mp4
   ```

2. **relative** - 相对路径
   ```
   ../movies/SSIS-001.mp4
   ```

3. **network** - 网络路径
   ```
   \\server\movies\SSIS-001.mp4
   smb://server/movies/SSIS-001.mp4
   ```

### 内容模式 (content_mode)

1. **simple** - 简单模式，只包含文件路径
   ```
   /path/to/movie.mp4
   ```

2. **detailed** - 详细模式，包含注释和元数据
   ```
   # Generated by Movie Data Capture Go
   # Movie: Movie Title (SSIS-001)
   # Actor: Actor Name
   # Studio: Studio Name
   # Release: 2024-01-20
   
   /path/to/movie.mp4
   ```

3. **playlist** - M3U播放列表格式
   ```
   #EXTM3U
   #EXTINF:-1,Movie Title
   /path/to/movie.mp4
   ```

### 分片模式 (multipart_mode)

1. **separate** - 为每个分片创建单独的STRM文件
   ```
   SSIS-001-Part1.strm
   SSIS-001-Part2.strm
   SSIS-001-Part3.strm
   ```

2. **combined** - 创建单个包含所有分片的STRM文件
   ```
   SSIS-001.strm (包含所有分片路径)
   ```

## 使用场景

### 场景1：本地媒体服务器

```yaml
strm:
  enable: true
  path_type: "absolute"
  content_mode: "simple"
  multipart_mode: "separate"
  validate_files: true
```

适用于：Kodi、Jellyfin本地服务器，保持原始文件位置不变。

### 场景2：网络存储(NAS)

```yaml
strm:
  enable: true
  path_type: "network"
  content_mode: "detailed"
  network_base_path: "\\\\nas-server\\movies"
  use_windows_path: true
  validate_files: false
```

适用于：通过网络访问NAS存储的媒体文件。

### 场景3：Docker容器

```yaml
strm:
  enable: true
  path_type: "absolute"
  content_mode: "simple"
  network_base_path: "/media/movies"
  validate_files: true
```

适用于：Docker容器中的媒体服务器，使用容器内路径。

## 高级配置

### 完整配置示例

```yaml
strm:
  enable: true                          # 启用STRM功能
  path_type: "network"                  # 使用网络路径
  content_mode: "detailed"              # 详细模式
  multipart_mode: "combined"            # 合并分片
  network_base_path: "\\\\server\\movies"  # 网络基础路径
  use_windows_path: true                # 使用Windows路径格式
  validate_files: false                 # 不验证网络文件
  strict_validation: false              # 非严格验证
  output_suffix: ""                     # 输出后缀
```

### 网络路径配置

#### Windows网络共享
```yaml
strm:
  network_base_path: "\\\\server\\movies"
  use_windows_path: true
```

#### SMB/CIFS (Linux/macOS)
```yaml
strm:
  network_base_path: "smb://server/movies"
  use_windows_path: false
```

#### FTP/HTTP
```yaml
strm:
  network_base_path: "ftp://server/movies"
  # 或
  network_base_path: "http://server/movies"
```

## 命令行使用

### 启用STRM模式处理单个文件
```bash
# 修改config.yaml中strm.enable=true，然后运行：
./mdc -file "SSIS-001.mp4"
```

### 批量处理并生成STRM文件
```bash
# 处理整个目录
./mdc -path "/path/to/movies"
```

### 使用软链接模式配合STRM
```yaml
common:
  link_mode: 1    # 软链接模式
strm:
  enable: true    # 同时生成STRM文件
```

## 媒体中心集成

### Kodi设置
1. 将STRM文件放在媒体库目录中
2. 在Kodi中添加视频源，指向包含STRM文件的目录
3. 设置刮削器为"本地信息"或使用NFO文件
4. 扫描媒体库

### Jellyfin设置
1. 将STRM文件和NFO文件放在媒体库目录
2. 在Jellyfin中添加媒体库，指向STRM文件目录
3. 启用"使用本地元数据"选项
4. 扫描媒体库

### Emby设置
类似于Jellyfin的设置步骤。

## 故障排除

### 常见问题

1. **STRM文件无法播放**
   - 检查路径是否正确
   - 确保媒体中心能访问源文件
   - 验证文件权限

2. **网络路径无法访问**
   - 检查网络连接
   - 验证SMB/CIFS设置
   - 确保防火墙允许访问

3. **分片文件播放顺序错误**
   - 使用 `multipart_mode: "combined"`
   - 设置 `content_mode: "playlist"`

### 调试建议

1. 启用详细日志：
   ```yaml
   debug_mode:
     switch: true
   ```

2. 启用文件验证：
   ```yaml
   strm:
     validate_files: true
     strict_validation: true
   ```

3. 检查生成的STRM文件内容：
   ```bash
   cat output/movie.strm
   ```

## 最佳实践

1. **选择合适的路径类型**
   - 本地使用：absolute
   - 网络存储：network
   - 便携性：relative

2. **分片文件处理**
   - 连续播放：combined + playlist
   - 单独管理：separate

3. **性能优化**
   - 网络路径关闭文件验证
   - 大量文件使用简单模式

4. **备份策略**
   - STRM文件体积小，易于备份
   - 保持原始文件和STRM文件同步

## 示例输出

### 简单模式输出
```
# 文件：SSIS-001.strm
/home/user/movies/SSIS-001.mp4
```

### 详细模式输出
```
# 文件：SSIS-001.strm
# Generated by Movie Data Capture Go
# Movie: 美しい人妻の秘密 (SSIS-001)
# Actor: 葵つかさ
# Studio: S1 NO.1 STYLE
# Release: 2024-01-20

/home/user/movies/SSIS-001.mp4
```

### 播放列表模式输出
```
# 文件：SSIS-001.strm
#EXTM3U
#EXTINF:-1,美しい人妻の秘密
/home/user/movies/SSIS-001.mp4
```

这个STRM功能为媒体库管理提供了极大的灵活性，特别适合不想移动原始文件但又需要良好媒体中心体验的用户。