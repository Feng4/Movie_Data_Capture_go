# STRM文件详细使用方式

## 什么是STRM文件？

STRM文件是包含媒体文件路径的纯文本文件，媒体中心软件（如Kodi、Jellyfin、Emby）可以读取这些文件来播放实际的媒体内容，而无需移动或复制原始文件。

## 基本使用流程

### 1. 启用STRM功能

在`config.yaml`中启用STRM功能：

```yaml
strm:
  enable: true                    # 启用STRM文件生成
  path_type: "absolute"           # 路径类型
  content_mode: "simple"          # 内容模式
  multipart_mode: "separate"      # 分片处理模式
```

### 2. 运行程序生成STRM文件

```bash
# 处理单个文件（会同时生成NFO和STRM文件）
./mdc -file "SSIS-001.mp4"

# 批量处理目录
./mdc -path "/path/to/movies"
```

### 3. 生成的文件结构示例

原始文件：
```
/home/user/movies/SSIS-001.mp4
```

生成的输出：
```
JAV_output/葵つかさ/SSIS-001-美しい人妻の秘密/
├── SSIS-001-美しい人妻の秘密.strm    # STRM文件
├── SSIS-001-美しい人妻の秘密.nfo     # NFO元数据文件
├── poster.jpg                      # 海报
├── fanart.jpg                      # 封面
└── thumb.jpg                       # 缩略图
```

STRM文件内容（simple模式）：
```
/home/user/movies/SSIS-001.mp4
```

## 不同模式的使用方式

### 1. 路径类型配置

#### 绝对路径模式（推荐本地使用）
```yaml
strm:
  enable: true
  path_type: "absolute"
```

生成的STRM文件内容：
```
/home/user/movies/SSIS-001.mp4
```

#### 相对路径模式
```yaml
strm:
  enable: true
  path_type: "relative"
```

生成的STRM文件内容：
```
../../movies/SSIS-001.mp4
```

#### 网络路径模式（NAS/网络存储）
```yaml
strm:
  enable: true
  path_type: "network"
  network_base_path: "\\\\server\\movies"  # Windows网络路径
  use_windows_path: true
```

生成的STRM文件内容：
```
\\server\movies\SSIS-001.mp4
```

或SMB格式：
```yaml
strm:
  network_base_path: "smb://server/movies"
  use_windows_path: false
```

生成的STRM文件内容：
```
smb://server/movies/SSIS-001.mp4
```

### 2. 内容模式配置

#### 简单模式
```yaml
strm:
  content_mode: "simple"
```

STRM文件内容：
```
/path/to/movie.mp4
```

#### 详细模式（推荐）
```yaml
strm:
  content_mode: "detailed"
```

STRM文件内容：
```
# Generated by Movie Data Capture Go
# Movie: 美しい人妻の秘密 (SSIS-001)
# Actor: 葵つかさ
# Studio: S1 NO.1 STYLE  
# Release: 2024-01-20

/path/to/movie.mp4
```

#### 播放列表模式
```yaml
strm:
  content_mode: "playlist"
```

STRM文件内容：
```
#EXTM3U
#EXTINF:-1,美しい人妻の秘密
/path/to/movie.mp4
```

### 3. 分片文件处理

#### 分别处理模式
```yaml
strm:
  multipart_mode: "separate"
```

对于分片文件`SSIS-001-cd1.mp4`, `SSIS-001-cd2.mp4`，会生成：
- `SSIS-001-Part1-美しい人妻の秘密.strm`
- `SSIS-001-Part2-美しい人妻の秘密.strm`

#### 合并处理模式
```yaml
strm:
  multipart_mode: "combined"
```

生成单个STRM文件：`SSIS-001-美しい人妻の秘密.strm`，内容包含所有分片：
```
# Multi-part movie
/path/to/SSIS-001-cd1.mp4
/path/to/SSIS-001-cd2.mp4
```

## 实际使用场景

### 场景1：本地媒体服务器

**适用情况**：
- 媒体服务器与原文件在同一台机器
- 希望保持原始文件位置不变
- 需要为不同媒体中心创建不同的组织方式

**配置**：
```yaml
common:
  link_mode: 1                    # 软链接模式（可选）

strm:
  enable: true
  path_type: "absolute"
  content_mode: "detailed"
  multipart_mode: "separate"
  validate_files: true            # 验证文件存在
```

**使用步骤**：
```bash
# 1. 处理电影文件
./mdc -path "/home/user/raw_movies"

# 2. 将生成的文件夹添加到媒体中心
# Kodi: 添加视频源 -> JAV_output文件夹
# Jellyfin: 添加媒体库 -> JAV_output文件夹
```

### 场景2：NAS网络存储

**适用情况**：
- 媒体服务器通过网络访问NAS上的文件
- 多个设备共享同一个媒体库
- 需要在不同设备间保持路径一致性

**配置**：
```yaml
strm:
  enable: true
  path_type: "network"
  network_base_path: "\\\\nas-server\\movies"
  use_windows_path: true
  content_mode: "detailed"
  validate_files: false           # 网络文件不验证存在性
```

**使用步骤**：
```bash
# 1. 确保能访问网络路径
# Windows: \\nas-server\movies
# Linux/macOS: smb://nas-server/movies

# 2. 处理文件
./mdc -path "./local_movies"

# 3. 将STRM文件复制到媒体服务器
# 4. 在媒体中心中添加STRM文件目录
```

### 场景3：Docker容器环境

**适用情况**：
- 使用Docker运行媒体服务器
- 原始文件和媒体服务器在不同的容器或挂载点
- 需要跨容器访问文件

**配置**：
```yaml
strm:
  enable: true
  path_type: "absolute"
  network_base_path: "/media/movies"  # 容器内路径
  content_mode: "simple"
  validate_files: true
```

**Docker Compose示例**：
```yaml
version: '3'
services:
  jellyfin:
    image: jellyfin/jellyfin
    volumes:
      - ./JAV_output:/config/media    # STRM文件目录
      - /host/movies:/media/movies    # 原始文件目录
```

### 场景4：多媒体中心支持

**适用情况**：
- 同时使用多个媒体中心软件
- 每个媒体中心需要不同的元数据格式
- 希望统一管理而不重复存储

**配置**：
```yaml
# 为Kodi优化
strm:
  enable: true
  path_type: "absolute"
  content_mode: "detailed"
  
# 同时启用其他功能
extrafanart:
  switch: true                    # Kodi额外封面
  
actor_photo:
  download_for_kodi: true         # Kodi演员照片
```

## 媒体中心配置

### Kodi配置

1. **添加视频源**：
   - 设置 -> 媒体设置 -> 库 -> 视频 -> 添加视频源
   - 选择包含STRM文件的目录
   - 设置刮削器为"本地信息"

2. **刮削器设置**：
   ```
   设置 -> 媒体设置 -> 库 -> 视频 -> 电影刮削器
   - 选择：本地信息
   - 启用：NFO文件
   ```

3. **扫描媒体库**：
   ```
   视频 -> 文件 -> 扫描项目到库
   ```

### Jellyfin配置

1. **添加媒体库**：
   - 控制台 -> 库 -> 添加媒体库
   - 类型：电影
   - 文件夹：选择STRM文件目录

2. **元数据设置**：
   ```
   高级设置:
   ☑ 启用实时监控
   ☑ 从本地文件导入缺失的元数据
   ```

3. **扫描库**：
   ```
   控制台 -> 库 -> 扫描库
   ```

### Emby配置

类似于Jellyfin的配置步骤。

## 测试和验证

### 1. 测试STRM文件生成

```bash
# 运行STRM测试工具
go run test_strm.go

# 或使用编译后的版本
./mdc-strm-test
```

### 2. 验证STRM文件内容

```bash
# 查看生成的STRM文件
cat "JAV_output/actor/movie/movie.strm"

# 验证路径是否正确
ls -la "$(cat 'JAV_output/actor/movie/movie.strm')"
```

### 3. 媒体中心测试

1. 在媒体中心中添加STRM文件目录
2. 扫描媒体库
3. 检查是否能正确识别电影信息
4. 尝试播放，验证是否能正常访问源文件

## 故障排除

### 问题1：STRM文件无法播放

**可能原因**：
- 路径不正确
- 媒体中心无法访问源文件
- 权限问题

**解决方案**：
```bash
# 验证路径是否正确
cat movie.strm
ls -la /path/shown/in/strm/file

# 检查权限
chmod 644 *.strm
chmod 755 source_directory
```

### 问题2：网络路径无法访问

**解决方案**：
```bash
# 测试网络连接
ping nas-server

# Windows测试SMB连接
net use \\server\share

# Linux测试SMB连接  
smbclient //server/share -U username
```

### 问题3：分片文件播放顺序错误

**解决方案**：
```yaml
# 使用合并模式 + 播放列表
strm:
  multipart_mode: "combined"
  content_mode: "playlist"
```

### 问题4：容器中路径映射问题

**检查Docker挂载**：
```bash
docker inspect container_name | grep Mounts -A 20
```

**修正路径映射**：
```yaml
# docker-compose.yml
volumes:
  - /host/path:/container/path
```

## 高级技巧

### 1. 批量转换现有库

```bash
# 设置为分析模式，不移动文件，只生成STRM
# config.yaml:
# common:
#   main_mode: 3
# strm:
#   enable: true

./mdc -path "/existing/library"
```

### 2. 自定义路径处理

```yaml
strm:
  path_type: "network"
  network_base_path: "http://media-server:8080/movies"
  # 生成HTTP流媒体链接
```

### 3. 与现有NFO文件配合

STRM功能会自动与NFO生成配合工作，确保：
- STRM文件名与NFO文件名匹配
- 媒体中心能正确关联元数据和视频内容

这样，你就拥有了一个完整且灵活的媒体库管理方案！